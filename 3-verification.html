<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verification Panel ‚Äî Bingo</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --gold: #f5c842;
    --accent: #e94560;
    --green: #2ea043;
    --green-light: #0ab68b;
    --blue: #4a90d9;
    --text: #e6edf3;
    --muted: #8b949e;
    --border: rgba(255,255,255,0.08);
    --winner: rgba(10,182,139,0.1);
    --invalid: rgba(233,69,96,0.1);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* Login */
  #loginOverlay {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    flex-direction: column;
    gap: 16px;
  }

  #loginOverlay h1 {
    font-family: 'Fredoka One', cursive;
    color: var(--gold);
    font-size: 2rem;
  }

  .login-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 100%;
    max-width: 340px;
    text-align: center;
  }

  .login-card input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255,255,255,0.05);
    border: 1.5px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-size: 1.1rem;
    text-align: center;
    letter-spacing: 0.1em;
    outline: none;
    margin-bottom: 12px;
  }

  .login-card input:focus { border-color: var(--gold); }

  .btn-login {
    width: 100%;
    padding: 12px;
    background: var(--gold);
    color: #1a1a2e;
    border: none;
    border-radius: 10px;
    font-family: 'Fredoka One', cursive;
    font-size: 1.2rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .btn-login:hover { opacity: 0.9; }
  .login-err { color: var(--accent); font-size: 0.85rem; margin-top: 8px; display: none; }

  /* Main */
  #mainPanel { display: none; }

  nav {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  nav .brand {
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    color: var(--gold);
  }

  nav .badge {
    background: rgba(233,69,96,0.2);
    border: 1px solid rgba(233,69,96,0.3);
    color: var(--accent);
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 24px 16px;
  }

  /* Search */
  .search-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
  }

  .search-card h2 {
    font-family: 'Fredoka One', cursive;
    color: var(--gold);
    font-size: 1.2rem;
    margin-bottom: 16px;
  }

  .search-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .search-row input {
    flex: 1;
    padding: 14px 18px;
    background: rgba(255,255,255,0.05);
    border: 1.5px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    outline: none;
    text-transform: uppercase;
  }

  .search-row input:focus { border-color: var(--gold); }

  .btn-verify {
    padding: 14px 28px;
    background: linear-gradient(135deg, var(--gold), #e8b800);
    color: #1a1a2e;
    border: none;
    border-radius: 10px;
    font-family: 'Fredoka One', cursive;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .btn-verify:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 20px rgba(245,200,66,0.3);
  }

  .btn-verify:disabled { opacity: 0.6; cursor: not-allowed; }

  /* Result card */
  .result-card {
    background: var(--card);
    border-radius: 20px;
    padding: 32px;
    display: none;
    animation: slideUp 0.4s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .result-header {
    text-align: center;
    padding: 28px;
    border-radius: 14px;
    margin-bottom: 28px;
  }

  .result-header.winner {
    background: var(--winner);
    border: 2px solid rgba(10,182,139,0.4);
  }

  .result-header.invalid {
    background: var(--invalid);
    border: 2px solid rgba(233,69,96,0.4);
  }

  .result-emoji { font-size: 4rem; animation: bounce 0.5s ease; }

  @keyframes bounce {
    0% { transform: scale(0); }
    60% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .result-verdict {
    font-family: 'Fredoka One', cursive;
    font-size: 3rem;
    letter-spacing: 0.05em;
    margin: 8px 0;
  }

  .result-verdict.winner { color: var(--green-light); }
  .result-verdict.invalid { color: var(--accent); }

  .result-patterns {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--muted);
  }

  /* Details grid */
  .details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
  }

  @media (max-width: 600px) {
    .details-grid { grid-template-columns: 1fr; }
    .search-row { flex-direction: column; }
    .btn-verify { width: 100%; }
  }

  .detail-item {
    padding: 12px 16px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 10px;
  }

  .detail-item .label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 4px;
  }

  .detail-item .value {
    font-weight: 800;
    font-size: 1rem;
    color: var(--text);
  }

  /* Bingo grid display */
  .grid-display {
    margin-bottom: 24px;
  }

  .grid-display h3 {
    font-family: 'Fredoka One', cursive;
    color: var(--muted);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
  }

  .bingo-header-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-bottom: 6px;
  }

  .bingo-header-row div {
    text-align: center;
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    padding: 8px;
  }

  .bingo-header-row div:nth-child(1) { color: #e94560; }
  .bingo-header-row div:nth-child(2) { color: #f5c842; }
  .bingo-header-row div:nth-child(3) { color: #0ab68b; }
  .bingo-header-row div:nth-child(4) { color: #4a90d9; }
  .bingo-header-row div:nth-child(5) { color: #a855f7; }

  .bingo-grid-disp {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
  }

  .grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    font-weight: 900;
    font-size: 1.1rem;
    border: 2px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.04);
    color: var(--muted);
    font-family: 'Nunito', sans-serif;
    position: relative;
    transition: all 0.2s;
  }

  .grid-cell.matched {
    animation: cellMatch 0.4s ease backwards;
    color: #1a1a2e;
    font-weight: 900;
  }

  @keyframes cellMatch {
    from { transform: scale(0.7); }
    to { transform: scale(1); }
  }

  .grid-cell.matched.col-0 { background: #e94560; border-color: #e94560; }
  .grid-cell.matched.col-1 { background: #f5c842; border-color: #f5c842; }
  .grid-cell.matched.col-2 { background: #0ab68b; border-color: #0ab68b; }
  .grid-cell.matched.col-3 { background: #4a90d9; border-color: #4a90d9; }
  .grid-cell.matched.col-4 { background: #a855f7; border-color: #a855f7; }

  .grid-cell.free {
    background: linear-gradient(135deg, #0ab68b, #2ea043);
    border-color: #0ab68b;
    color: white;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 0.05em;
  }

  .grid-cell.win-highlight::after {
    content: '‚úì';
    position: absolute;
    top: 2px; right: 4px;
    font-size: 0.6rem;
    color: rgba(255,255,255,0.7);
  }

  /* Photo */
  .photo-section {
    margin-top: 20px;
  }

  .photo-section h3 {
    font-family: 'Fredoka One', cursive;
    color: var(--muted);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
  }

  .photo-section img {
    max-width: 100%;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.1);
    display: block;
  }

  .spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 3px solid rgba(26,26,46,0.3);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-box {
    background: rgba(233,69,96,0.1);
    border: 1px solid rgba(233,69,96,0.3);
    color: #ff6b8a;
    padding: 14px 18px;
    border-radius: 10px;
    font-weight: 700;
    display: none;
    margin-top: 12px;
  }
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
  <h1>üîç Verification Panel</h1>
  <div class="login-card">
    <p style="color:var(--muted);margin-bottom:16px;font-size:0.9rem;">Enter moderator password</p>
    <input type="password" id="pwdInput" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()">Access Panel</button>
    <div class="login-err" id="loginErr">Incorrect password. Try again.</div>
  </div>
</div>

<!-- Main Panel -->
<div id="mainPanel">
  <nav>
    <div class="brand">üîç Verification Panel</div>
    <div class="badge">Moderator Only</div>
  </nav>

  <div class="container">
    <div class="search-card">
      <h2>Verify a Bingo Winner</h2>
      <p style="color:var(--muted);font-size:0.85rem;margin-bottom:16px;">
        Enter the CARD-ID from the player's comment (e.g. "BINGO ‚Äì CARD-042")
      </p>
      <div class="search-row">
        <input type="text" id="cardIdInput" placeholder="CARD-001" maxlength="12"
          onkeydown="if(event.key==='Enter')verifyCard()"
          oninput="this.value=this.value.toUpperCase()">
        <button class="btn-verify" id="verifyBtn" onclick="verifyCard()">
          üîç Verify
        </button>
      </div>
      <div class="error-box" id="errorBox"></div>
    </div>

    <div class="result-card" id="resultCard">
      <!-- Filled dynamically -->
    </div>
  </div>
</div>

<script>
// ================================================================
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw_2nRn4UPrfNksf1YcG49YDDV90rsN-bzg9kJgdmQHWTeSXIddyTVEktbjK1wuRxT/exec";
// ================================================================

let password = '';

function doLogin() {
  password = document.getElementById('pwdInput').value;
  if (!password) return;
  
  // Validate mod password by calling getRegistrations (it checks mod OR host password)
  apiCall({ action: 'getRegistrations', password })
    .then(data => {
      if (data.success) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainPanel').style.display = 'block';
      } else {
        document.getElementById('loginErr').style.display = 'block';
      }
    })
    .catch(() => {
      document.getElementById('loginErr').style.display = 'block';
    });
}

async function verifyCard() {
  const cardId = document.getElementById('cardIdInput').value.trim().toUpperCase();
  const errBox = document.getElementById('errorBox');
  const result = document.getElementById('resultCard');
  
  errBox.style.display = 'none';
  result.style.display = 'none';
  
  if (!cardId) {
    errBox.textContent = 'Please enter a Card ID.';
    errBox.style.display = 'block';
    return;
  }

  const btn = document.getElementById('verifyBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Verifying...';

  try {
    const data = await apiCall({ action: 'verify', cardId, password });
    
    if (!data.success) {
      errBox.textContent = '‚ùå ' + data.error;
      errBox.style.display = 'block';
    } else {
      renderResult(data);
    }
  } catch(e) {
    errBox.textContent = '‚ùå Network error. Please try again.';
    errBox.style.display = 'block';
  }

  btn.disabled = false;
  btn.innerHTML = 'üîç Verify';
}

function renderResult(data) {
  const result = document.getElementById('resultCard');
  const isWinner = data.isWinner;
  
  const ts = new Date(data.registrationTimestamp).toLocaleString('en-PH', {
    dateStyle: 'medium', timeStyle: 'short'
  });

  let gridHTML = '';
  data.grid.forEach((row, r) => {
    row.forEach((cell, c) => {
      const classes = ['grid-cell'];
      if (cell.free) classes.push('free');
      else if (cell.matched) {
        classes.push('matched', `col-${c}`);
        if (isWinner) classes.push('win-highlight');
      }
      
      gridHTML += `<div class="${classes.join(' ')}" style="animation-delay:${(r*5+c)*0.04}s">
        ${cell.free ? 'FREE' : cell.value}
      </div>`;
    });
  });

  const patternsText = isWinner
    ? `üèÜ Winning pattern${data.patterns.length > 1 ? 's' : ''}: ${data.patterns.join(' ‚Ä¢ ')}`
    : '';

  result.innerHTML = `
    <div class="result-header ${isWinner ? 'winner' : 'invalid'}">
      <div class="result-emoji">${isWinner ? 'üèÜ' : '‚ùå'}</div>
      <div class="result-verdict ${isWinner ? 'winner' : 'invalid'}">
        ${isWinner ? 'VALID WINNER' : 'INVALID CLAIM'}
      </div>
      ${patternsText ? `<div class="result-patterns">${patternsText}</div>` : ''}
      ${!isWinner ? `<div class="result-patterns" style="color:var(--muted)">No winning pattern found with current drawn numbers</div>` : ''}
    </div>

    <div class="details-grid">
      <div class="detail-item">
        <div class="label">Card ID</div>
        <div class="value">${data.cardId}</div>
      </div>
      <div class="detail-item">
        <div class="label">Registered Name</div>
        <div class="value">${data.fullName}</div>
      </div>
      <div class="detail-item">
        <div class="label">Mobile</div>
        <div class="value">${data.mobile}</div>
      </div>
      <div class="detail-item">
        <div class="label">Registration Time</div>
        <div class="value">${ts}</div>
      </div>
      <div class="detail-item">
        <div class="label">Numbers Drawn</div>
        <div class="value">${data.drawnCount} / 75</div>
      </div>
      <div class="detail-item">
        <div class="label">Status</div>
        <div class="value" style="color:${isWinner ? 'var(--green-light)' : 'var(--accent)'}">
          ${isWinner ? '‚úÖ CONFIRMED' : '‚õî REJECTED'}
        </div>
      </div>
    </div>

    <div class="grid-display">
      <h3>üìã Card Grid ‚Äî Highlighted matches</h3>
      <div class="bingo-header-row">
        <div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>
      </div>
      <div class="bingo-grid-disp">${gridHTML}</div>
    </div>

    ${data.photoUrl ? `
      <div class="photo-section">
        <h3>üì∏ Registered Card Photo</h3>
        <img src="${data.photoUrl}" alt="Bingo card photo" onerror="this.alt='Photo not available'; this.style.display='none'">
      </div>
    ` : ''}
  `;

  result.style.display = 'block';
  result.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function apiCall(data) {
  const url = new URL(APPS_SCRIPT_URL);
  for (const [k, v] of Object.entries(data)) {
    url.searchParams.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
  }
  return JSON.parse(await (await fetch(url.toString())).text());
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('pwdInput').focus();
});
</script>
</body>
</html>
